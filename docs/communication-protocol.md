# 与上位机通信协议

本文档定义了本设备（程序）与上位机之间通过串口进行的通信协议。本协议旨在通过使用整数编码和缩短键名来减小数据体积。

## 1. 编码字典

为了减少传输数据的大小，所有命令和事件类型都由整数代码表示。

**命令码 (上位机 -> 程序):**
| 命令         | `c` (command) |
|--------------|---------------|
| `start`      | 1             |
| `heartbeat`  | 2             |
| `stop`       | 3             |

**事件/响应码 (程序 -> 上位机):**
| 类型          | `t` (type) |
|---------------|------------|
| `status`      | 1          |
| `error`       | 2          |
| `device`      | 3          |

**数据键名 (data):**
| 完整键名       | `d` (data) 内的缩写键 |
|----------------|--------------------------|
| `message`      | `msg`                    |
| `running`      | `run`                    |
| `manufacturer` | `mf`                     |
| `rssi`         | `rs`                     |

## 2. 通信格式

**请求格式 (上位机 -> 程序):**
```json
{
  "c": <command_code>,
  "d": {}
}
```

**响应/上报格式 (程序 -> 上位机):**
```json
{
  "t": <type_code>,
  "d": {}
}
```

---

## 3. API 定义

### 3.1 启动命令 (`c: 1`)

*   **功能**: 启动蓝牙扫描。
*   **上位机 -> 程序**:
    ```json
    { "c": 1, "d": { "rssi": "-60" } }
    ```
*   **程序 -> 上位机 (响应)**:
    *   成功 (`t: 1`): `{"t": 1, "d": {"msg": "Scan started"}}`
    *   失败 (`t: 2`): `{"t": 2, "d": {"msg": "Failed to start scan"}}`

### 3.2 心跳命令 (`c: 2`)

*   **功能**: 查询程序运行状态。
*   **上位机 -> 程序**:
    ```json
    { "c": 2 }
    ```
*   **程序 -> 上位机 (响应)** (`t: 1`):
    ```json
    {
      "t": 1,
      "d": { "run": true }
    }
    ```

### 3.3 关闭命令 (`c: 3`)

*   **功能**: 停止蓝牙扫描并关闭串口连接。
*   **上位机 -> 程序**:
    ```json
    { "c": 3 }
    ```
*   **程序 -> 上位机 (响应)** (`t: 1`):
    ```json
    {
      "t": 1,
      "d": { "msg": "Scan stopped" }
    }
    ```

### 3.4 上报命令 (主动上报, `t: 3`)

*   **功能**: 主动上报扫描到的蓝牙设备信息。
*   **程序 -> 上位机**:
    ```json
    {
      "t": 3,
      "d": {
        "mf": "Apple, Inc."
      }
    }
    ```
