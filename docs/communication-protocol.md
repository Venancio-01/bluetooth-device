# 蓝牙设备串口通信协议

本文档定义了本蓝牙设备与上位机之间通过TTL串口进行的通信协议。

## 1. 串口配置

| 参数               | 值     |
| ------------------ | ------ |
| 波特率 (Baud Rate) | 115200 |
| 数据位 (Data Bits) | 8      |
| 停止位 (Stop Bits) | 1      |
| 校验位 (Parity)    | None   |
| 流控 (Flow Control)  | None   |

## 2. 编码字典

为了减少传输数据的大小，所有命令和事件类型都由整数代码表示。

**命令码 (上位机 -> 设备):**
| 命令         | `c` (command) | 描述 |
|--------------|---------------|------|
| `start`      | 1             | 启动扫描 |
| `stop`       | 2             | 停止扫描 |

**事件/响应码 (设备 -> 上位机):**
| 类型          | `t` (type) | 描述 |
|---------------|------------|------|
| `status`      | 1          | 状态 |
| `error`       | 2          | 错误 |
| `device`      | 3          | 扫描到设备 |
| `heartbeat`   | 4          | 心跳 |

**数据键名 (data):**
| 完整键名       | `d` (data) 内的缩写键 | 描述 |
|----------------|--------------------------|------|
| `message`      | `msg`                    | 消息 |
| `running`      | `run`                    | 运行状态 |
| `manufacturer` | `mf`                     | 制造商 |
| `rssi`         | `rs`                     | RSSI 信号强度 |
| `deviceId`     | `did`                    | 设备标识符 |
| `serialPath`   | `sp`                     | 串口路径 |

**厂商列表 (Manufacturer):**

支持检测的厂商列表如下：

| 公司名       | 制造商(Manufacturer)                               |
|--------------|--------------------------------------|
| `诺基亚`     | Nokia Mobile Phones                  |
| `摩托罗拉`   | Motorola                             |
| `苹果`       | Apple, Inc.                          |
| `索尼`       | Sony Ericsson Mobile Communications  |
| `三星`       | Samsung Electronics Co. Ltd.         |
| `LG`         | LG Electronics                       |
| `谷歌`       | Google                               |

## 3. 通信格式

**所有消息均为json格式，以换行符 (\r\n) 结尾。**

**请求格式 (上位机 -> 设备):**
```json
{
  "c": <command_code>,
  "d": {}
}
```

**响应/上报格式 (设备 -> 上位机):**
```json
{
  "t": <type_code>,
  "d": {}
}
```

---

## 4. API 定义

### 4.1 启动命令 (`c: 1`)

*   **功能**: 启动蓝牙扫描，并设置 RSSI 阈值，如不传 RSSI 阈值则默认使用 `-60`。支持指定特定设备或所有设备。启动成功后设备主动上报扫描到的设备信息。失败时返回失败原因。
*   **上位机 -> 设备**:
    *   扫描所有设备: `{ "c": 1, "d": { "rssi": "-60" } }`
    *   扫描指定设备: `{ "c": 1, "d": { "rssi": "-60", "did": "device_id" } }`
*   **设备 -> 上位机 (响应)**:
    *   成功响应: `{"t": 1, "d": {"msg": "Scan started"}}`
    *   失败响应: `{"t": 2, "d": {"msg": "Port busy"}}`

### 4.2 停止命令 (`c: 3`)

*   **功能**: 停止蓝牙扫描。支持指定特定设备或所有设备。成功后设备将停止主动上报扫描到的设备信息。失败时返回失败原因。
*   **上位机 -> 设备**:
    *   停止所有设备: `{ "c": 3 }`
    *   停止指定设备: `{ "c": 3, "d": { "did": "device_id" } }`
*   **设备 -> 上位机 (响应)**:
    *   成功响应: `{"t": 1, "d": {"msg": "Scan stopped"}}`
    *   失败响应: `{"t": 2, "d": {"msg": "Port busy"}}`

### 4.3 设备信息上报 (主动上报, `t: 3`)

*   **功能**: 主动上报扫描到的蓝牙设备制造商信息，制造商信息由厂商列表定义。现在包含设备标识信息。
*   **设备 -> 上位机**:
    响应示例：`{ "t": 3, "d": { "mf": "Apple, Inc.", "did": "device_id", "sp": "/dev/ttyUSB0" } }`

### 4.4 心跳上报 (主动上报, `t: 4`)

*   **功能**: 主动上报设备心跳。设备激活后，在待检测状态下每 2 秒向上位机发送一次心跳包。
*   **设备 -> 上位机**:
    响应示例：`{ "t": 4, "d": { "run": true } }`
